<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Trading Points充值</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
   	 	<link rel="stylesheet" type="text/css" href="../css/aui.css" />
   	 	<style type="text/css">
   	 		body{
   	 			background: #fff;
   	 		}
   	 		.prompt-header{
   	 			width: 100%;
   	 			height: 2rem;
   	 			background: #ddd;
   	 		}
   	 		.prompt-header-text{
   	 			padding-left: 10%;
   	 			line-height: 2rem;
   	 		}
   	 		.prompt-header-text span{
   	 			float: left;
   	 			color: #444;
   	 		}
   	 		.prompt-header-text a{
   	 			float: left;
				display: block;
				height: 1rem;
				line-height: 1rem;
   	 			background: orange;
   	 			margin-top: 0.5rem;
   	 			margin-left: 5px;
   	 			padding: 0 0.5rem;
   	 			border-radius: 0.5rem;
   	 			color: #eee;
   	 		}
   	 		.content{
   	 			width: 50%;
   	 			margin: auto;
   	 			padding-top: 1.5rem;
   	 			padding-bottom: 2rem;
   	 		}
   	 		.content span{
   	 			display: block;
   	 			text-align: center;
   	 			padding: 0.1rem 0;
   	 		}
   	 		.content span:nth-child(2){
   	 			color: #444;
   	 		}
   	 		.content span:nth-child(3){
   	 			color: orange;
   	 		}
   	 		.content span:nth-child(4){
   	 			color: #ddd;
   	 		}
   	 		.password{
   	 			width: 90%;
   	 			margin: auto;
   	 			padding-bottom: 1.5rem;
   	 		}
   	 		.password .user-pass,.password .determine-pass{
   	 			border-bottom: 1px solid #ddd;
   	 		}
   	 		.password span{
   	 			display: inline-block;
   	 			width: 20%;
   	 			height: 1rem;
   	 			font-weight: bold;
   	 			text-align: center;
   	 			line-height: 1rem;
   	 			color: #666;
   	 		}
   	 		.password input{
   	 			display: inline-block;
   	 			width: 75%;
   	 			height: 2rem;
   	 			box-sizing: border-box;
   	 			-webkit-box-sizing: border-box;
   	 			text-indent: 1rem;
   	 		}
   	 		.password input::-webkit-input-placeholder{
   	 			color: #aaa;
   	 		}
   	 		.prompt{
   	 			width: 90%;
   	 			margin: auto;
   	 			padding-top:0.5rem;
   	 			padding-bottom: 2.5rem;
   	 		}
   	 		.prompt p{
   	 			color: #ddd;
   	 		}
   	 		.btn{
   	 			display: block;
   	 			margin:auto;
   	 			width: 50%;
   	 			height: 1.5rem;
   	 			background: orange;
   	 			border-radius: 0.75rem;
   	 			color: #fff;
   	 		}
				.sub_box .active{
					background-color: #cccccc !important;
				}
   	 		.determine-pass{
   	 			height: 2rem;
   	 			line-height: 2rem;
   	 		}
   	 		.determine-pass span:nth-child(2){
   	 			width: 60%;
   	 			color: #aaa;
   	 			text-align: left;
   	 			font-weight: 200;
   	 			text-indent: 1rem;
   	 		}
   	 		.determine-pass span:nth-child(3){
   	 			width: 10%;
   	 			color: #aaa;
   	 		}
			.contentbox {
				display: none;
			}
			.imgbox {
				width: 100%;
				align-items: center;
				display: flex;
			}
            .submit.active{
                background: #cccccc;
            }
      .box-bottom{
        margin-top: 2rem;
        width: 100%;
        color: #999;
        margin-bottom: 2rem;
      }
      .box-bottom>span{
        margin-left: 1rem;
      }
      .box-bottom-text{
        margin-top: 1rem;
        line-height: 1rem;
        font-size: 0.7rem;
      }
      .box-bottom-text img{
        float: left;
        display: block;
        width: 0.8rem;
        height: 1rem;
        margin-left: 1rem;
        margin-right: 0.3rem;
        margin-top: -0.2rem;
      }
      .box-bottom-text span{
        display: inline-block;
        width: calc(100% - 2.8rem);
        color: #666;
        margin-left: 0.1rem;
      }
   	 	</style>
	</head>
	<body>
		<div class="top_box">
            <div class="isenable">
                <div class="aui-font-size-12">您还未实名认证地，无法兑换</div>
    	        <div class="aui-btn aui-btn-warning aui-btn-sm aui-margin-t-10" style="border-radius: 2rem;" onclick="go_url(799)">
    	            个人认证
    	        </div>
            </div>
            <!-- <div class="isverified">
                <div class="aui-font-size-12 aui-margin-t-10" onclick="go_url(801)">
    		        您当前未设置安全密码，请先&nbsp;&nbsp;
    		        <div class="aui-btn aui-btn-warning aui-btn-sm" style="border-radius: 2rem;">
    			    设置安全密码
    		        </div>
    	        </div>
            </div> -->
        </div>

		<div class="content aui-margin-t-15">
      <div class="box-top">
			<img src="../image/299846564472362590.png" />
			<div class="box-top-text">
        <span class="aui-font-size-14">
				<p class="aui-margin-t-10">Trading Points余额</p>
	            <h1 class="aui-text-warning aui-margin-t-10" name='total'></h1></span>
		    </div>
      </div>
		</div>


		<div style="height: 0.5rem;width: 100%;background: #eee;margin-bottom: 0.4rem;"></div>

	<div class="aui-content aui-margin-b-15">
        <ul class="aui-list aui-form-list">
            <li class="aui-list-item">
		        <div class="aui-list-item-inner">
		            <div class="aui-list-item-label" style="font-size:.5rem;">
		                    充值金额
		            </div>
		            <div class="aui-list-item-input">
		                <input class="aui-font-size-14" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" type="text" name="account" placeholder="请输入您需要充值Trading Points的金额">
		            </div>
		        </div>
		    </li>
			<li class="aui-list-item">
               <div class="aui-list-item-inner">
                   <div class="aui-list-item-label" style="font-size:.5rem;">
                       支付方式
                   </div>
                   <div class="aui-list-item-input">
                       <select name="payment" class="aui-font-size-14">
                           <option  value="0">请选择</option>
                           <option  value="1">银行转账</option>
                           <option  value="2">支付宝/微信</option>
						   <!-- <option value="5">信用卡</option> -->
                           <option  value="3">CloudUnion Account</option>
                           <option  value="4">Prepayment Account</option>
                       </select>
                   </div>
               </div>
           </li>
           <li class="aui-list-item">
               <div class="aui-list-item-inner">
                   <div class="aui-list-item-label" style="font-size:.5rem;">
                       安全密码
                   </div>
                   <div class="aui-list-item-input">
                       <input class="aui-font-size-14" type="password" name="password" placeholder="请输入安全密码">
                   </div>
               </div>
           </li>
        </ul>
    </div>

    <div class="aui-content aui-margin-b-15 contentbox contentbox1">
        <ul class="aui-list aui-list-in">
            <li class="aui-list-header">
               Cloud Union (Australia) Network Technology Aus Pty Ltd
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-title">Bank: Australia and New Zealand Banking Group Limited</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-title">BSB: 013225</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-title">Bank Address: 10 Main St，Box Hill ，VIC 3128，Australia</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-title">Account: 417207277</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-title">Oversea Swift Code: ANZBAU3M</div>
                </div>
            </li>
        </ul>
		<!--  支付凭证上传-->
        <div class="container">
            <div class="page-header">
                <form id="uploadForm" enctype='multipart/form-data'>
                    <div class="form-group">
                        <div class="fileinput fileinput-new" data-provides="fileinput"  id="exampleInputUpload">
                            <div class="fileinput-new thumbnail" style="width: 200px;height: auto;max-height:150px;">
                                 <img id='payment_pic1' onclick="showAction('payment_pic1')" style="width: 100%;height: auto;max-height: 140px;" src="../image/authpic1.jpg" alt="请上传支付凭证" />
                            </div>
                            <div class="fileinput-preview fileinput-exists thumbnail" style="max-width: 200px; max-height: 150px;"></div>
                            <div>
                              <!-- <a href="javascript:;" class="btn btn-warning fileinput-exists" data-dismiss="fileinput">移除</a> -->
                            </div>
                        </div>
                    </div>
                </form>
                请上传支付凭证
            </div>
         </div>
    </div>
    <div class="aui-content aui-margin-b-15 contentbox contentbox2">
        <img src="../image/wechat_alipay.png" alt="支付宝付款二维码" style="width:18rem;">
		<!--  支付凭证上传-->
        <div class="container">
            <div class="page-header">
                <form id="uploadForm" enctype='multipart/form-data'>
                    <div class="form-group">
                        <div class="fileinput fileinput-new" data-provides="fileinput"  id="exampleInputUpload">
                            <div class="fileinput-new thumbnail" style="width: 200px;height: auto;max-height:150px;">
                                 <img id='payment_pic2' onclick="showAction('payment_pic2')" style="width: 100%;height: auto;max-height: 140px;" src="../image/authpic1.jpg" alt="请上传支付凭证" />
                            </div>
                            <div class="fileinput-preview fileinput-exists thumbnail" style="max-width: 200px; max-height: 150px;"></div>
                            <div>
                              <!-- <a href="javascript:;" class="btn btn-warning fileinput-exists" data-dismiss="fileinput">移除</a> -->
                            </div>
                        </div>
                    </div>
                </form>
                请上传支付凭证
            </div>
         </div>
    </div>
	<div class="sub_box aui-margin-b-15 aui-margin-t-15">
		 <div class="aui-btn aui-btn-warning aui-btn-block aui-btn-sm submit" style="border-radius: 2rem;" id = "TP_topup_submit">
		 提交
		 </div>
	</div>

<div class="box-bottom">
      <span>温馨提示</span>
      <div class="box-bottom-text">
	    <ul>
		    <li class="aui-margin-t-5 aui-margin-b-10 aui-font-size-12">
			    <img src="../image/fd165844513guygsidgfi4864.png">
			    <div>充值金额需为整数</div>
		    </li>
				<li class="aui-margin-t-5 aui-margin-b-10 aui-font-size-12">
          <img src="../image/fd165844513guygsidgfi4864.png">
          <div>信用卡收取3%手续费</div>
        </li>
		    <li class="aui-margin-t-5 aui-margin-b-10 aui-font-size-12">
			    <img src="../image/fd165844513guygsidgfi4864.png">
			    <div>1 AUD = 625 Trading Points</div>
		    </li>
        <li class="aui-margin-t-5 aui-margin-b-10 aui-font-size-12">
          <img src="../image/fd165844513guygsidgfi4864.png">
          <div>Trading Points 充值前需输入安全密码</div>
        </li>
         <li class="aui-margin-t-5 aui-margin-b-10 aui-font-size-12">
          <img src="../image/fd165844513guygsidgfi4864.png">
          <div>会员需认证后才能充值Trading Points</div>
        </li>
	    </ul>
    </div>
    </div>
	</body>
<script type="text/javascript" src="../script/apiURL.js"></script>
</html>

<!-- <div class="bottom_box" id="bottom_time">
	<div class="shuai_box aui-font-size-14 aui-border-b">
		<div class="aui-pull-left aui-margin-l-15" onclick="show_dayselect()">
			<span class="day_text">今天</span>
			<i class="aui-iconfont aui-icon-down"></i>
		</div>
		<div class="day_box aui-font-size-12 isshow">
			<li>今天</li>
			<li>昨天</li>
			<li>近三天</li>
			<li>近一个月</li>
		</div>
		<div class="aui-pull-right aui-margin-r-15" onclick="show_filter()">
			<img src="../image/060113.png" >
			&nbsp;时间筛选
		</div>
	</div>
	<div class="pie">
		<div class="pie_left aui-pull-left">
			<div class="pie_main" id="mypie">

			</div>
			<div class="change_icon aui-font-size-14 aui-text-warning">
				&nbsp;&nbsp;&nbsp;
				<img src="../image/change_icon.png" />
				Income/Expenses
			</div>
		</div>
		<div class="pie_right aui-pull-left aui-padded-t-15 aui-margin-l-10">
			<h3>收入</h3>
			<h2 class="aui-text-warning">0.00</h2>
		</div>
	</div>
</div> -->


<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src='../script/moment.min.js'></script>
<!-- 时间筛选 -->
<script type="text/javascript" src="../script/mydateselect.js"></script>
<!-- 饼图 -->
<script type="text/javascript" src="../plugin/echarts/echarts.common.min.js"></script>
<script type="text/javascript">

var apiurl = '';
var token = '';
var id = '';
var username = '';
var userinfo = '';
var img = '';
var paymentid = '';
var resultStatus=false;
var resultVal='';
var cardAccount = '';
var password2 = '';
var number2 = '';
function GetRequest() {
   var url = location.search; //获取url中"?"符后的字串
   var theRequest = new Object();
   if (url.indexOf("?") != -1) {
      var str = url.substr(1);
      strs = str.split("&");
      for(var i = 0; i < strs.length; i ++) {
         theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
      }
   }
   return theRequest;
}
var strr="function GetRequest(){var url = location.search;var theRequest = new Object();if (url.indexOf('?') != -1) {var str = url.substr(1);strs = str.split('&');for(var i = 0; i < strs.length; i ++) {theRequest[strs[i].split('=')[0]]=unescape(strs[i].split('=')[1]);}}return theRequest;}window.setInterval(function(){console.log(JSON.stringify(GetRequest()));},2000);"

apiready = function() {
    // api.parseTapmode();
    // var header = $api.byId('top_box');
    var storage= window.localStorage;
    apiurl=api_au;
    var enable = storage.getItem('ylh_authorization_enable');
    var verified = storage.getItem('ylh_authorization_verified');
    token = storage.getItem('ylh_authorization_token');
    id = storage.getItem('ylh_authorization_id');
    username = storage.getItem('ylh_authorization_username');
    if (enable) $('.isenable').css('display', 'none');
    if (verified) $('.verified').css('display', 'none');
	userinfo = JSON.parse(storage.getItem('ylh_authorization_userinfo'));
	$('h1[name="total"]').html(userinfo.tradingPoint.toFixed(2));
	//添加监听时间，刷新数据
	api.addEventListener({
		name: 'update'
	}, function(ret, err) {
		window.location.reload();
	});
}
$('select[name="payment"]').on('change', function(event) {
	$('.contentbox').hide();
    $('.contentbox' + $(this).val()).show();
});
var paystatus=true;
function canpay() {
    $('.submit').removeClass('active');
    paystatus=true;
}

function notpay() {
    $('.submit').addClass('active');
    paystatus=false;
}

   function go_url(typenub) {
      var jsfun = 'go_url('+typenub+');';
      api.execScript({
          script: jsfun
      });
   }
   $('.submit').on('click', function () {
	   $('#TP_topup_submit').css('display', 'block');
       var number = moment().local().format('YYMMDD');
       var account = $('input[name="account"]').val();
	   var password = $('input[name="password"]').val();
		var payment = $('select[name="payment"]').val();
		if (payment == 0 || account == '' || password == '' || (img == '' && (payment == 1 || payment == 2))) {
			alert('请上传支付凭证并填写完整信息');
      $('#TP_topup_submit').css('display', 'block');
			return false;
		}
		if(paystatus){
		    notpay();

            if (payment == 1 || payment == 2) {
                var body = {
                    "accountIn": "TP",
                    "accountInAmount": account * 625,
                    "accountOut": "EN",
                    "accountOutAmount": 0,
                    "memberId": id,
                    "method": "OFFLINE_TRANSFER",
                    "paymentType": "OFFLINE_TOP_UP_TP",
                    "securityPassword": password,
                    "serialNumHeader": "ot" + number,
                    "serviceCharge": 0
                }
                var tmpurl = 'payment/create';
            }else if (payment == 5) {
                cardAccount = account;
                password2 = password;
                number2 = number;
                var body = {
                    "accountIn": "PA",
                    "accountInAmount": account,
                    "accountOut": "EN",
                    "accountOutAmount": account * 1.03,
                    "memberId": id,
                    "method": "PAYMENT_EXPRESS",
                    "paymentType": "PA_TOP_UP",
                    "securityPassword": password,
                    "serialNumHeader": "pt" + number,
                    "serviceCharge": 0
                }
                var tmpurl = 'payment/create';
            } else {
                switch (payment) {
                    case '3':
                        // var serviceCharge = account * 0.05;
                        var serviceCharge = 0;
                        var tmppayment = 'CA';
                        var pre = 'c';
                        var transactionType = 'CA_TO_TP';
                        break;
                    case '4':
                        var serviceCharge = 0;
                        var tmppayment = 'PA'
                        var pre = 'p';
                        var transactionType = 'PA_TO_TP';
                        break;
                    default:
                }
                var body = {
                    "accountIn": "TP",
                    "accountInAmount": account * 625,
                    "accountOut": tmppayment,
                    "accountOutAmount": account,
                    "fromMemberId": id,
                    "securityPassword": password,
                    "serialNumHeader": pre + "t" + number,
                    "serviceCharge": serviceCharge,
                    "toMemberId": id,
                    "transactionType": transactionType
                };
                var tmpurl = 'transaction/create';
            }

            //GP增加
            <!-- api.ajax({ -->
            <!-- url: apiurl + 'transaction/create', -->
            <!-- method: 'post', -->
            <!-- headers: { -->
            <!-- 'Content-Type': 'application/json;charset=utf-8', -->
            <!-- 'authorization': 'Bearer ' + token -->
            <!-- }, -->
            <!-- returnAll: true, -->
            <!-- data: { -->
            <!-- body: { -->
            <!-- "accountIn": "GP", -->
            <!-- "accountInAmount": account * 100, -->
            <!-- "accountOut": "NA", -->
            <!-- "accountOutAmount": 0, -->
            <!-- "fromMemberId": id, -->
            <!-- "securityPassword": password, -->
            <!-- "serialNumHeader": "TG" + number, -->
            <!-- "serviceCharge": account * 100 * 3/23, -->
            <!-- "toMemberId": id, -->
            <!-- "transactionType": "TP_TO_GP" -->
            <!-- } -->
            <!-- } -->
            <!-- }, function(ret, err) { -->
            <!-- if(ret){ -->

            <!-- }else{ -->
            <!-- api.toast({ -->
            <!-- msg: '创建交易明细失败', -->
            <!-- duration: 3000, -->
            <!-- location: 'middle' -->
            <!-- }); -->
            <!-- } -->
            <!-- }); -->

            api.ajax({
                method:"post",
                url:apiurl + "resource/store",
                headers: {
                    'Content-Type': 'application/json;charset=utf-8',
                    'authorization': 'Bearer ' + token
                },
                data:{
                    body: {
                        "data": img.substr(23),
                        "fileName": id + '_' + 'payment_pic',
                        "memberId": id,
                        "path": id + "/",
                        "resourceType": 'PAYMENT'
                    }
                },
                dataType:'json',
                async:true,
            },function(ret,err){
                if(ret){

                }else{
                    api.toast({
                        msg: err.message,
                        duration: 3000,
                        location: 'middle'
                    });
                    <!-- $('#TP_topup_submit').css('display', 'block'); -->
                }
            })

            api.ajax({
                url: apiurl + tmpurl,
                method: 'post',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8',
                    'authorization': 'Bearer ' + token
                },
                returnAll: true,
                data: {
                    body: body
                }
            }, function(ret, err) {
                if(payment == 5){
//                    console.log(JSON.stringify(ret));
                    if(ret){
                        paymentid = ret.body.payment.id;
                        $('#TP_topup_submit').addClass('active');
                        paystatus=false;
                        goCreditCardUrl(id,paymentid,password);
                    }else {
                        api.toast({
                            msg: '安全密码错误',
                            duration: 2500,
                            location: 'middle'
                        });
                    }
                    canpay();
                    return false;
                }
                if (ret) {
                    api.ajax({
                        url: apiurl + 'transaction/create',
                        method: 'post',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8',
                            'authorization': 'Bearer ' + token
                        },
                        returnAll: true,
                        data: {
                            body: {
                                "accountIn": "GP",
                                "accountInAmount": account * 100,
                                "accountOut": "NA",
                                "accountOutAmount": 0,
                                "fromMemberId": id,
                                "securityPassword": password,
                                "serialNumHeader": "tg" + number,
                                "serviceCharge": account * 100 / 11,
                                "toMemberId": id,
                                "transactionType": "TP_TO_GP"
                            }
                        }
                    }, function(ret, err) {
                        if(ret){

                            if (ret.body.result == 'SUCCESS') {
                                alert('充值成功！');
                                api.sendEvent({
                                    name: 'update'
                                });
                                api.closeWin();
                                canpay();
                            } else {
                                alert('未知错误');
                                canpay();

                            }

                        }else{
                            api.toast({
                                msg: '充值失败，请再次尝试',
                                duration: 3000,
                                location: 'middle'
                            });
                            $('#TP_topup_submit').css('display', 'block');
                            canpay();
                        }
                    });

                    // <!-- if (ret.body.result == 'SUCCESS') { -->
                    // 	<!-- alert(ret.body.message); -->
                    // 	<!-- api.sendEvent({ -->
                    // 	    <!-- name: 'update' -->
                    // 	<!-- }); -->
                    // 	<!-- api.closeWin(); -->
                    // <!-- } else { -->
                    // 	<!-- alert(ret.body.message); -->
                    // <!-- } -->


                } else {
                    api.toast({
                        msg: '交易失败',
                        duration: 2500,
                        location: 'middle'
                    });
                    $('#TP_topup_submit').css('display', 'block');
                    canpay();
                }
            });
        }

   });

    // 上传图片
    function showAction(picImg){
         api.actionSheet({
             title: '上传图片',
             cancelTitle: '取消',
             buttons: ['拍照','从手机相册选择']
         }, function(ret, err) {
             if (ret) {
                 getPicture(ret.buttonIndex, picImg);
             }
         });
    }
	function getPicture(sourceType, picImg) {
        if(sourceType==1){ // 拍照
            api.getPicture({
                sourceType: 'camera',
                encodingType: 'jpg',
                mediaValue: 'pic',
                allowEdit: false,
                destinationType: 'base64',
                quality: 90,
                saveToPhotoAlbum: true
            }, function(ret, err) {
                if (ret) {
                    if (ret.base64Data == '') return false;
                    $('#' + picImg).attr('src', ret.base64Data);
                    img = ret.base64Data;
                }else {
                    api.alert('上传图片失败，请再次尝试');
                }
            });
        }
        else if(sourceType==2){ // 从相机中选择
            api.getPicture({
                    sourceType: 'library',
                    encodingType: 'jpg',
                    mediaValue: 'pic',
                    destinationType: 'base64',
                    quality: 50,
                    targetWidth: 750,
                    targetHeight: 750
                }, function(ret, err) {
                    if (ret) {
                        if (ret.base64Data == '') return false;
                        // $('#imgUp').attr('src', ret.base64Data)
                        var aa=ret.base64Data;
                        $('#' + picImg).attr('src',aa);
                        img = aa;
                    } else {
                        alert('上传图片失败，请再次尝试');
                    }
            });
        }
    }

   // 上传图片
   function showAction(picImg){
        api.actionSheet({
            title: '上传图片',
            cancelTitle: '取消',
            buttons: ['拍照','从手机相册选择']
        }, function(ret, err) {
            if (ret) {
                getPicture(ret.buttonIndex, picImg);
            }
        });
   }
	 function canpay() {
	     $('.submit').removeClass('active');
	     paystatus=true;
	 }
	 	 function goCreditCardUrl(memberid,paymentid,password){
	 		 api.ajax({
	 				 url: apiurl + 'payment/dps/create',
	 				 method: 'post',
	 				 headers: {
	 						 'Content-Type': 'application/json;charset=utf-8',
	 						 'authorization': 'Bearer ' + token
	 				 },
	 				 returnAll: true,
	 				 data: {
	 						 body: {
	 							"memberId":memberid,
	 							"paymentId":paymentid,
	 							"securityPassword":password
	 			      }
	 				 }
	 		 }, function(ret, err) {
                 if (ret) {
                     if (ret.body.result == 'SUCCESS') {
                         var url = ret.body.url;
                         // alert(url);
                         api.openFrame({
                             name: 'CreditCard',
                             url: url,
                             rect: {
                                 x: 0,
                                 y: 0,
                                 w: 'auto',
                                 h: 'auto'
                             }
                         });
                         api.addEventListener({
                             name: 'getUrl'
                         }, function(ret, err) {
                             if(ret && ret.value){
                                 var value = ret.value;
                                 //  console.log(JSON.stringify({msg: value.location.search}));
                                 var reg = new RegExp("(^|&)result=([^&]*)(&|$)");
                                 var r = value.location.search.substr(1).match(reg);
                                 if(r!=null){
                                     resultVal=unescape(r[2]);
                                     resultStatus=true;
                                 }
                             }
                         });
                         window.setTimeout(function(){canpay();},5000);
                         window.setTimeout(function(){
                             var timetime=window.setInterval(function(){
                                 if(resultStatus){
                                     resultStatus=false;
                                     window.clearInterval(timetime);
                                     api.closeFrame({name:'CreditCard'});
                                     //alert(resultVal);
                                     checkCreditCard(resultVal,paymentid,memberid);
                                 }
                                 var script = "api.sendEvent({name: 'getUrl', extra: {location: window.location}});";
                                 api.execScript({
                                     frameName: 'CreditCard',
                                     script: script
                                 });
                             },1000);
                         },5000);
                         //alert(JSON.stringify(ret));
                     } else {
                         api.toast({
                             msg: '未知错误',
                             duration: 2500,
                             location: 'middle'
                         });
                         canpay();
                     }
                 } else {
                     api.toast({
                         msg: '系统错误',
                         duration: 2500,
                         location: 'middle'
                     });
                     canpay();
                 }
	 		 });
	 	 }

	 	 function checkCreditCard(code,paymentid,memberids)
	 	 {
	 		 api.ajax({
	 				 url: apiurl + '/payment/dps/complete',
	 				 method: 'post',
	 				 headers: {
	 						 'Content-Type': 'application/json;charset=utf-8',
	 						 'authorization': 'Bearer ' + token
	 				 },
	 				 returnAll: true,
	 				 data: {
	 						 body: {
	 							 "paymentId":paymentid,
	                "result": code
	 			      }
	 				 }
	 		 }, function(ret, err) {
	 				 if (ret) {
	 			if (ret.body.result == 'SUCCESS') {
	 				if(ret.body.success){
						api.ajax({
							url: apiurl + 'transaction/create',
							method: 'post',
							headers: {
								'Content-Type': 'application/json;charset=utf-8',
								'authorization': 'Bearer ' + token
							},
							returnAll: true,
							data: {
								body: {
									"accountIn": "TP",
									"accountInAmount":cardAccount * 625,
									"accountOut": "PA",
									"accountOutAmount": cardAccount,
									"fromMemberId": memberids,
									"securityPassword": password2,
									"serialNumHeader": "pt" + number2,
									"serviceCharge": 0,
									"toMemberId": memberids,
									"transactionType": "PA_TOP_UP"
								}
							}
						}, function(ret, err){
							if (ret) {
								alert('充值成功');
								api.openWin({
                    name: 'index',
                    url: 'index4.html',
                    pageParam: {
                    }
									});
							} else {
								api.toast({
									msg: err.body.message,
									duration: 2500,
									location: 'middle'
								});
							}
						});
	 				}else{
	 					alert('充值失败');
	 				}
	 			} else {
	 				alert('交易失败');
	 			}
	 				 } else {
	 						 api.toast({
	 								 msg: '交易失败，请再次尝试',
	 								 duration: 2500,
	 								 location: 'middle'
	 						 });
	 				 }
	 		 });
	 	 }
</script>
